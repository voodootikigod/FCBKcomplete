(function(f){f.fn.extend({fcbkcomplete:function(i){i=f.extend({},f.FCBKCompleter.defaults,i);return this.each(function(){new f.FCBKCompleter(this,i)})},addItem:function(i,c){return this.trigger("addItem",[i,c])}});f.FCBKCompleter=function(i,c){function M(){j.hide();j.attr("multiple","multiple");j.attr("name").indexOf("[]")==-1&&j.attr("name",j.attr("name")+"[]");m=f(document.createElement("ul"));m.attr("class",c.holder_class);j.after(m);k=f(document.createElement("div"));k.addClass(c.results_class);
k.append('<div class="default">'+c.complete_text+"</div>");if(r){k.append('<iframe class="ie6fix" scrolling="no" frameborder="0"></iframe>');s=k.children(".ie6fix")}d=f(document.createElement("ul"));d.attr("id",w+"_feed");k.prepend(d);m.after(k);d.css("width",k.width())}function N(){j.children(":selected").addClass("selected");j.children("option").each(function(a,b){a=f(b);p.push(c.cache_object(a));v+=""+(p.length-1)+":"+a.text()+";"});j.children(".selected").each(function(a,b){a=f(b);t(a.text(),
a.val(),true)})}function t(a,b,e){a=a.replace(/^ */,"").replace(/ *$/,"");if(a===""){if(m.find(".bit-input input").length>0)m.find(".bit-input input")[0].value=""}else{var g=document.createElement("li"),l=document.createTextNode(a),u=document.createElement("a");f(g).attr({"class":"bit-box",rel:b});f(g).prepend(l);f(g).click(function(){f(this).toggleClass("deleted")});f(u).attr({"class":"closebutton",href:"#"});g.appendChild(u);m.append(g);f(u).click(function(){f(this).parent("li").fadeOut("fast",
function(){D(f(this))});return false});if(!e){f("#"+w+"_annoninput").remove();var n;E(1);if(j.children("option[value="+b+"]").length){n=j.children("option[value="+b+"]");n.get(0).setAttribute("selected","selected");n.hasClass("selected")||n.addClass("selected")}else{n=f(document.createElement("option"));n.attr("value",b).get(0).setAttribute("selected","selected");n.attr("value",b).addClass("selected");n.text(a);j.append(n)}c.onselect.length&&F(c.onselect,n)}m.children("li.bit-box.deleted").removeClass("deleted");
d.hide();r&&s.hide()}}function D(a){if(c.onremove.length){var b=j.children("option[value="+a.attr("rel")+"]");F(c.onremove,b)}j.children("option[value="+a.attr("rel")+"]").removeAttr("selected");j.children("option[value="+a.attr("rel")+"]").removeClass("selected");a.remove();y=0}function E(a){var b=f(document.createElement("li")),e=f(document.createElement("input"));b.attr({"class":"bit-input",id:w+"_annoninput"});e.attr({type:"text","class":"maininput",size:"1"});m.append(b.append(e));e.focus(function(){k.fadeIn("fast")});
e.blur(function(){var g=z(f(this).val());g&&c.accept_on_blur&&t(g,g);k.fadeOut("fast")});m.click(function(){e.focus();if(d.length&&e.val().length)d.show();else{d.hide();r&&s.hide();k.children(".default").show()}});e.keypress(function(g){if(A(g.keyCode))return false;e.attr("size",e.val().length+1)});e.keydown(function(g){if(g.keyCode==q.FORWARD_SLASH){g.preventDefault();return false}});e.keyup(function(g){var l=z(e.val());if(g.keyCode==q.BACKSPACE&&l.length==0){d.hide();r&&s.hide();if(m.children("li.bit-box.deleted").length==
0){m.children("li.bit-box:last").addClass("deleted");return false}else{if(y)return;y=1;m.children("li.bit-box.deleted").fadeOut("fast",function(){D(f(this));return false})}}if(g.keyCode!=q.DOWN&&g.keyCode!=q.UP&&l.length!=0){x=0;if(c.json_url)if(c.cache&&G){B(l);C()}else{clearTimeout(H);H=setTimeout(function(){f.getJSON(c.json_url+"?tag="+l,null,function(u){B(l,u);G=true;C()})},c.delay)}else{B(l);C()}k.children(".default").hide();d.show()}});a&&setTimeout(function(){e.focus();k.children(".default").show()},
1)}function B(a,b){d.html("");if(!c.cache){p=[];v=""}O(a);b!=null&&b.length&&f.each(b,function(n,I){p.push(c.cache_object(I));v+=""+(p.length-1)+":"+c.to_search_string(I)+";"});b=c.maxshownitems<p.length?c.maxshownitems:p.length;var e="i";if(c.filter_case)e="";var g,l;try{g=eval("/(?:^|;)\\s*(\\d+)\\s*:[^;]*?"+a+"[^;]*/g"+e);l=g.exec(v)}catch(u){}for(a="";l!=null&&b>0;){l=p[l[1]];if(!(c.filter_selected&&j.children("option[value="+l.value+"]").hasClass("selected"))){a+=c.render_cache_object(l);x++;
b--}l=g.exec(v)}d.append(a);if(c.firstselected){h=d.children("li:visible:first");h.addClass("auto-focus")}if(x>c.height){d.css({height:c.height*24+"px",overflow:"auto"});r&&s.css({height:c.height*24+"px",width:d.width()+"px"}).show()}else{d.css("height","auto");r&&s.css({height:d.height()+"px",width:d.width()+"px"}).show()}}function J(){d.children("li").mouseover(function(){d.children("li").removeClass("auto-focus");f(this).addClass("auto-focus");h=f(this)});d.children("li").mouseout(function(){f(this).removeClass("auto-focus");
h=null})}function K(){d.children("li").unbind("mouseover");d.children("li").unbind("mouseout");d.mousemove(function(){J();d.unbind("mousemove")})}function C(){var a=f("#"+w+"_annoninput").children(".maininput");J();d.children("li").unbind("mousedown");d.children("li").mousedown(function(){var b=f(this);t(c.item_text(b),b.attr("rel"));d.hide();r&&s.hide();k.hide()});a.unbind("keydown");a.keydown(function(b){if(b.keyCode==q.FORWARD_SLASH){b.preventDefault();return false}b.keyCode!=q.BACKSPACE&&m.children("li.bit-box.deleted").removeClass("deleted");
if(A(b.keyCode)&&L()){var e=h,g=e.item_text(e);e=e.attr("rel");if(!e||jQuery.trim(e)==="")e=g;t(g,e);k.hide();b.preventDefault();h=null;return false}if(A(b.keyCode)&&!L()){if(c.newel){g=z(f(this).val());t(g,g);k.hide();b.preventDefault();h=null}return false}if(b.keyCode==q.DOWN){K();if(h==null||h.length==0){h=d.children("li:visible:first");d.get(0).scrollTop=0}else{h.removeClass("auto-focus");h=h.nextAll("li:visible:first");g=parseInt(h.prevAll("li:visible").length,10);e=parseInt(h.nextAll("li:visible").length,
10);if((g>Math.round(c.height/2)||e<=Math.round(c.height/2))&&typeof h.get(0)!="undefined")d.get(0).scrollTop=parseInt(h.get(0).scrollHeight,10)*(g-Math.round(c.height/2))}d.children("li").removeClass("auto-focus");h.addClass("auto-focus")}if(b.keyCode==q.UP){K();if(h==null||h.length==0){h=d.children("li:visible:last");d.get(0).scrollTop=parseInt(h.get(0).scrollHeight,10)*(parseInt(d.children("li:visible").length,10)-Math.round(c.height/2))}else{h.removeClass("auto-focus");h=h.prevAll("li:visible:first");
g=parseInt(h.prevAll("li:visible").length,10);e=parseInt(h.nextAll("li:visible").length,10);if((e>Math.round(c.height/2)||g<=Math.round(c.height/2))&&typeof h.get(0)!="undefined")d.get(0).scrollTop=parseInt(h.get(0).scrollHeight,10)*(g-Math.round(c.height/2))}d.children("li").removeClass("auto-focus");h.addClass("auto-focus")}})}function O(a){if(c.newel){d.children("li[fckb=1]").remove();if(a.length!=0){var b=f(document.createElement("li"));b.attr({rel:a,fckb:"1"}).html(a);d.prepend(b);x++}}}function F(a,
b){var e="";for(o=0;o<b.get(0).attributes.length;o++)if(b.get(0).attributes[o].nodeValue!=null)e+='"_'+b.get(0).attributes[o].nodeName+'": "'+b.get(0).attributes[o].nodeValue+'",';e="{"+e+" notinuse: 0}";try{eval(a+"("+e+")")}catch(g){}}function L(){if(h==null)return false;if(h.length==0)return false;return true}function z(a){a=a.replace(/[\"\'][\s]*javascript:(.*)[\"\']/g,'""');a=a.replace(/script(.*)/g,"");a=a.replace(/eval\((.*)\)/g,"");return a=a.replace("/([\u0000-\u0008,\u000b-\u000c,\u000e-\u0019])/",
"")}function A(a){return c.sep_keycodes[a]===true}var q={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,FORWARD_SLASH:191},m=null,d=null,k=null,x=0,p=[],G=false,v="",h=null,y=0,r=false,s,H=false,j=f(i),w=j.attr("id");M();N();E(0);i={};for(var o=0;o<c.sep_keycodes.length;o++)i[c.sep_keycodes[o]]=true;c.sep_keycodes=i;j.bind("addItem",function(a,b,e){t(b,e)})};f.FCBKCompleter.defaults={holder_class:"holder",results_class:"facebook-auto",complete_text:"Start to type...",
accept_on_blur:false,cache:true,filter_case:false,filter_hide:false,firstselected:false,height:"10",json_url:null,maxshownitems:20,newel:false,onselect:"",onremove:"",delay:500,sep_keycodes:[13],item_text:function(i){return i.text()},to_search_string:function(i){return i.caption},render_cache_object:function(i){return'<li rel="'+i.value+'">'+itemIllumination(i.caption,etext)+"</li>"},cache_object:function(i){return i.caption?{caption:i.caption,value:i.value}:{caption:i.text(),value:i.val()}}}})(jQuery);
