(function(f){f.fn.extend({fcbkcomplete:function(i){i=f.extend({},f.FCBKCompleter.defaults,i);return this.each(function(){new f.FCBKCompleter(this,i)})},addItem:function(i,b){return this.trigger("addItem",[i,b])}});f.FCBKCompleter=function(i,b){function M(){j.hide();j.attr("multiple","multiple");j.attr("name").indexOf("[]")==-1&&j.attr("name",j.attr("name")+"[]");m=f(document.createElement("ul"));m.attr("class",b.holder_class);j.after(m);k=f(document.createElement("div"));k.addClass(b.results_class);
k.append('<div class="default">'+b.complete_text+"</div>");if(r){k.append('<iframe class="ie6fix" scrolling="no" frameborder="0"></iframe>');s=k.children(".ie6fix")}d=f(document.createElement("ul"));d.attr("id",w+"_feed");k.prepend(d);m.after(k);d.css("width",k.width())}function N(){j.children(":selected").addClass("selected");j.children("option").each(function(c,a){option=f(a);p.push(option.cache_object(option));v+=""+(p.length-1)+":"+option.text()+";"});j.children(".selected").each(function(c,a){option=
f(a);t(option.text(),option.val(),true)})}function t(c,a,e){c=c.replace(/^ */,"").replace(/ *$/,"");if(c==="")m.find(".bit-input input")[0].value="";else{var h=document.createElement("li"),l=document.createTextNode(c),u=document.createElement("a");f(h).attr({"class":"bit-box",rel:a});f(h).prepend(l);f(h).click(function(){f(this).toggleClass("deleted")});f(u).attr({"class":"closebutton",href:"#"});h.appendChild(u);m.append(h);f(u).click(function(){f(this).parent("li").fadeOut("fast",function(){D(f(this))});
return false});if(!e){f("#"+w+"_annoninput").remove();var n;E(1);if(j.children("option[value="+a+"]").length){n=j.children("option[value="+a+"]");n.get(0).setAttribute("selected","selected");n.hasClass("selected")||n.addClass("selected")}else{n=f(document.createElement("option"));n.attr("value",a).get(0).setAttribute("selected","selected");n.attr("value",a).addClass("selected");n.text(c);j.append(n)}b.onselect.length&&F(b.onselect,n)}m.children("li.bit-box.deleted").removeClass("deleted");d.hide();
r&&s.hide()}}function D(c){if(b.onremove.length){var a=j.children("option[value="+c.attr("rel")+"]");F(b.onremove,a)}j.children("option[value="+c.attr("rel")+"]").removeAttr("selected");j.children("option[value="+c.attr("rel")+"]").removeClass("selected");c.remove();y=0}function E(c){var a=f(document.createElement("li")),e=f(document.createElement("input"));a.attr({"class":"bit-input",id:w+"_annoninput"});e.attr({type:"text","class":"maininput",size:"1"});m.append(a.append(e));e.focus(function(){k.fadeIn("fast")});
e.blur(function(){var h=z(f(this).val());h&&b.accept_on_blur&&t(h,h);k.fadeOut("fast")});m.click(function(){e.focus();if(d.length&&e.val().length)d.show();else{d.hide();r&&s.hide();k.children(".default").show()}});e.keypress(function(h){if(A(h.keyCode))return false;e.attr("size",e.val().length+1)});e.keydown(function(h){if(h.keyCode==q.FORWARD_SLASH){h.preventDefault();return false}});e.keyup(function(h){var l=z(e.val());if(h.keyCode==q.BACKSPACE&&l.length==0){d.hide();r&&s.hide();if(m.children("li.bit-box.deleted").length==
0){m.children("li.bit-box:last").addClass("deleted");return false}else{if(y)return;y=1;m.children("li.bit-box.deleted").fadeOut("fast",function(){D(f(this));return false})}}if(h.keyCode!=q.DOWN&&h.keyCode!=q.UP&&l.length!=0){x=0;if(b.json_url)if(b.cache&&G){B(l);C()}else{clearTimeout(H);H=setTimeout(function(){f.getJSON(b.json_url+"?tag="+l,null,function(u){B(l,u);G=true;C()})},b.delay)}else{B(l);C()}k.children(".default").hide();d.show()}});c&&setTimeout(function(){e.focus();k.children(".default").show()},
1)}function B(c,a){d.html("");if(!b.cache){p=[];v=""}O(c);a!=null&&a.length&&f.each(a,function(n,I){p.push(b.cache_object(I));v+=""+(p.length-1)+":"+b.to_search_string(I)+";"});a=b.maxshownitems<p.length?b.maxshownitems:p.length;var e="i";if(b.filter_case)e="";var h,l;try{h=eval("/(?:^|;)\\s*(\\d+)\\s*:[^;]*?"+c+"[^;]*/g"+e);l=h.exec(v)}catch(u){}for(c="";l!=null&&a>0;){l=p[l[1]];if(!(b.filter_selected&&j.children("option[value="+l.value+"]").hasClass("selected"))){c+=b.render_cache_object(l);x++;
a--}l=h.exec(v)}d.append(c);if(b.firstselected){g=d.children("li:visible:first");g.addClass("auto-focus")}if(x>b.height){d.css({height:b.height*24+"px",overflow:"auto"});r&&s.css({height:b.height*24+"px",width:d.width()+"px"}).show()}else{d.css("height","auto");r&&s.css({height:d.height()+"px",width:d.width()+"px"}).show()}}function J(){d.children("li").mouseover(function(){d.children("li").removeClass("auto-focus");f(this).addClass("auto-focus");g=f(this)});d.children("li").mouseout(function(){f(this).removeClass("auto-focus");
g=null})}function K(){d.children("li").unbind("mouseover");d.children("li").unbind("mouseout");d.mousemove(function(){J();d.unbind("mousemove")})}function C(){var c=f("#"+w+"_annoninput").children(".maininput");J();d.children("li").unbind("mousedown");d.children("li").mousedown(function(){var a=f(this);t(b.item_text(a),a.attr("rel"));d.hide();r&&s.hide();k.hide()});c.unbind("keydown");c.keydown(function(a){if(a.keyCode==q.FORWARD_SLASH){a.preventDefault();return false}a.keyCode!=q.BACKSPACE&&m.children("li.bit-box.deleted").removeClass("deleted");
if(A(a.keyCode)&&L()){var e=g;t(b.item_text(e),e.attr("rel"));k.hide();a.preventDefault();g=null;return false}if(A(a.keyCode)&&!L()){if(b.newel){e=z(f(this).val());t(e,e);k.hide();a.preventDefault();g=null}return false}if(a.keyCode==q.DOWN){K();if(g==null||g.length==0){g=d.children("li:visible:first");d.get(0).scrollTop=0}else{g.removeClass("auto-focus");g=g.nextAll("li:visible:first");e=parseInt(g.prevAll("li:visible").length,10);var h=parseInt(g.nextAll("li:visible").length,10);if((e>Math.round(b.height/
2)||h<=Math.round(b.height/2))&&typeof g.get(0)!="undefined")d.get(0).scrollTop=parseInt(g.get(0).scrollHeight,10)*(e-Math.round(b.height/2))}d.children("li").removeClass("auto-focus");g.addClass("auto-focus")}if(a.keyCode==q.UP){K();if(g==null||g.length==0){g=d.children("li:visible:last");d.get(0).scrollTop=parseInt(g.get(0).scrollHeight,10)*(parseInt(d.children("li:visible").length,10)-Math.round(b.height/2))}else{g.removeClass("auto-focus");g=g.prevAll("li:visible:first");e=parseInt(g.prevAll("li:visible").length,
10);h=parseInt(g.nextAll("li:visible").length,10);if((h>Math.round(b.height/2)||e<=Math.round(b.height/2))&&typeof g.get(0)!="undefined")d.get(0).scrollTop=parseInt(g.get(0).scrollHeight,10)*(e-Math.round(b.height/2))}d.children("li").removeClass("auto-focus");g.addClass("auto-focus")}})}function O(c){if(b.newel){d.children("li[fckb=1]").remove();if(c.length!=0){var a=f(document.createElement("li"));a.attr({rel:c,fckb:"1"}).html(c);d.prepend(a);x++}}}function F(c,a){var e="";for(o=0;o<a.get(0).attributes.length;o++)if(a.get(0).attributes[o].nodeValue!=
null)e+='"_'+a.get(0).attributes[o].nodeName+'": "'+a.get(0).attributes[o].nodeValue+'",';e="{"+e+" notinuse: 0}";try{eval(c+"("+e+")")}catch(h){}}function L(){if(g==null)return false;if(g.length==0)return false;return true}function z(c){c=c.replace(/[\"\'][\s]*javascript:(.*)[\"\']/g,'""');c=c.replace(/script(.*)/g,"");c=c.replace(/eval\((.*)\)/g,"");return c=c.replace("/([\u0000-\u0008,\u000b-\u000c,\u000e-\u0019])/","")}function A(c){return b.sep_keycodes[c]===true}var q={UP:38,DOWN:40,DEL:46,
TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,FORWARD_SLASH:191},m=null,d=null,k=null,x=0,p=[],G=false,v="",g=null,y=0,r=false,s,H=false,j=f(i),w=j.attr("id");M();N();E(0);i={};for(var o=0;o<b.sep_keycodes.length;o++)i[b.sep_keycodes[o]]=true;b.sep_keycodes=i;j.bind("addItem",function(c,a,e){t(a,e)})};f.FCBKCompleter.defaults={holder_class:"holder",results_class:"facebook-auto",complete_text:"Start to type...",accept_on_blur:false,cache:true,filter_case:false,filter_hide:false,
firstselected:false,height:"10",json_url:null,maxshownitems:20,newel:false,onselect:"",onremove:"",delay:500,sep_keycodes:[13],item_text:function(i){return i.text()},to_search_string:function(i){return i.caption},render_cache_object:function(i){return'<li rel="'+i.value+'">'+itemIllumination(i.caption,etext)+"</li>"},cache_object:function(i){return i.caption?{caption:i.caption,value:i.value}:{caption:i.text(),value:i.val()}}}})(jQuery);
