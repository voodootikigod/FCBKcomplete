(function(f){f.fn.extend({fcbkcomplete:function(j){j=f.extend({},f.FCBKCompleter.defaults,j);return this.each(function(){new f.FCBKCompleter(this,j)})},addItem:function(j,d){return this.trigger("addItem",[j,d])}});f.FCBKCompleter=function(j,d){function M(){i.hide();i.attr("multiple","multiple");i.attr("name").indexOf("[]")==-1&&i.attr("name",i.attr("name")+"[]");m=f(document.createElement("ul"));m.attr("class",d.holder_class);i.after(m);k=f(document.createElement("div"));k.addClass(d.results_class);
k.append('<div class="default">'+d.complete_text+"</div>");if(r){k.append('<iframe class="ie6fix" scrolling="no" frameborder="0"></iframe>');s=k.children(".ie6fix")}c=f(document.createElement("ul"));c.attr("id",w+"_feed");k.prepend(c);m.after(k);c.css("width",k.width())}function N(){i.children(":selected").addClass("selected");i.children("option").each(function(b,a){option=f(a);p.push(option.cache_object(option));v+=""+(p.length-1)+":"+option.text()+";"});i.children(".selected").each(function(b,a){option=
f(a);t(option.text(),option.val(),true)})}function t(b,a,e){b=b.replace(/^ */,"").replace(/ *$/,"");if(b==="")m.find(".bit-input input")[0].value="";else{var h=document.createElement("li"),l=document.createTextNode(b),u=document.createElement("a");f(h).attr({"class":"bit-box",rel:a});f(h).prepend(l);f(h).click(function(){f(this).toggleClass("deleted")});f(u).attr({"class":"closebutton",href:"#"});h.appendChild(u);m.append(h);f(u).click(function(){f(this).parent("li").fadeOut("fast",function(){D(f(this))});
return false});if(!e){f("#"+w+"_annoninput").remove();var n;E(1);if(i.children("option[value="+a+"]").length){n=i.children("option[value="+a+"]");n.get(0).setAttribute("selected","selected");n.hasClass("selected")||n.addClass("selected")}else{n=f(document.createElement("option"));n.attr("value",a).get(0).setAttribute("selected","selected");n.attr("value",a).addClass("selected");n.text(b);i.append(n)}d.onselect.length&&F(d.onselect,n)}m.children("li.bit-box.deleted").removeClass("deleted");c.hide();
r&&s.hide()}}function D(b){if(d.onremove.length){var a=i.children("option[value="+b.attr("rel")+"]");F(d.onremove,a)}i.children("option[value="+b.attr("rel")+"]").removeAttr("selected");i.children("option[value="+b.attr("rel")+"]").removeClass("selected");b.remove();y=0}function E(b){var a=f(document.createElement("li")),e=f(document.createElement("input"));a.attr({"class":"bit-input",id:w+"_annoninput"});e.attr({type:"text","class":"maininput",size:"1"});m.append(a.append(e));e.focus(function(){k.fadeIn("fast")});
e.blur(function(){var h=z(f(this).val());h&&d.accept_on_blur&&t(h,h);k.fadeOut("fast")});m.click(function(){e.focus();if(c.length&&e.val().length)c.show();else{c.hide();r&&s.hide();k.children(".default").show()}});e.keypress(function(h){if(A(h.keyCode))return false;e.attr("size",e.val().length+1)});e.keydown(function(h){if(h.keyCode==q.FORWARD_SLASH){h.preventDefault();return false}});e.keyup(function(h){var l=z(e.val());if(h.keyCode==q.BACKSPACE&&l.length==0){c.hide();r&&s.hide();if(m.children("li.bit-box.deleted").length==
0){m.children("li.bit-box:last").addClass("deleted");return false}else{if(y)return;y=1;m.children("li.bit-box.deleted").fadeOut("fast",function(){D(f(this));return false})}}if(h.keyCode!=q.DOWN&&h.keyCode!=q.UP&&l.length!=0){x=0;if(d.json_url)if(d.cache&&G){B(l);C()}else{clearTimeout(H);H=setTimeout(function(){f.getJSON(d.json_url+"?tag="+l,null,function(u){B(l,u);G=true;C()})},d.delay)}else{B(l);C()}k.children(".default").hide();c.show()}});b&&setTimeout(function(){e.focus();k.children(".default").show()},
1)}function B(b,a){c.html("");if(!d.cache){p=[];v=""}O(b);a!=null&&a.length&&f.each(a,function(n,I){p.push(d.cache_object(I));v+=""+(p.length-1)+":"+I.caption+";"});a=d.maxshownitems<p.length?d.maxshownitems:p.length;var e="i";if(d.filter_case)e="";var h,l;try{h=eval("/(?:^|;)\\s*(\\d+)\\s*:[^;]*?"+b+"[^;]*/g"+e);l=h.exec(v)}catch(u){}for(b="";l!=null&&a>0;){l=p[l[1]];if(!(d.filter_selected&&i.children("option[value="+l.value+"]").hasClass("selected"))){b+=d.render_cache_object(l);x++;a--}l=h.exec(v)}c.append(b);
if(d.firstselected){g=c.children("li:visible:first");g.addClass("auto-focus")}if(x>d.height){c.css({height:d.height*24+"px",overflow:"auto"});r&&s.css({height:d.height*24+"px",width:c.width()+"px"}).show()}else{c.css("height","auto");r&&s.css({height:c.height()+"px",width:c.width()+"px"}).show()}}function J(){c.children("li").mouseover(function(){c.children("li").removeClass("auto-focus");f(this).addClass("auto-focus");g=f(this)});c.children("li").mouseout(function(){f(this).removeClass("auto-focus");
g=null})}function K(){c.children("li").unbind("mouseover");c.children("li").unbind("mouseout");c.mousemove(function(){J();c.unbind("mousemove")})}function C(){var b=f("#"+w+"_annoninput").children(".maininput");J();c.children("li").unbind("mousedown");c.children("li").mousedown(function(){var a=f(this);t(a.text(),a.attr("rel"));c.hide();r&&s.hide();k.hide()});b.unbind("keydown");b.keydown(function(a){if(a.keyCode==q.FORWARD_SLASH){a.preventDefault();return false}a.keyCode!=q.BACKSPACE&&m.children("li.bit-box.deleted").removeClass("deleted");
if(A(a.keyCode)&&L()){var e=g;t(e.text(),e.attr("rel"));k.hide();a.preventDefault();g=null;return false}if(A(a.keyCode)&&!L()){if(d.newel){e=z(f(this).val());t(e,e);k.hide();a.preventDefault();g=null}return false}if(a.keyCode==q.DOWN){K();if(g==null||g.length==0){g=c.children("li:visible:first");c.get(0).scrollTop=0}else{g.removeClass("auto-focus");g=g.nextAll("li:visible:first");e=parseInt(g.prevAll("li:visible").length,10);var h=parseInt(g.nextAll("li:visible").length,10);if((e>Math.round(d.height/
2)||h<=Math.round(d.height/2))&&typeof g.get(0)!="undefined")c.get(0).scrollTop=parseInt(g.get(0).scrollHeight,10)*(e-Math.round(d.height/2))}c.children("li").removeClass("auto-focus");g.addClass("auto-focus")}if(a.keyCode==q.UP){K();if(g==null||g.length==0){g=c.children("li:visible:last");c.get(0).scrollTop=parseInt(g.get(0).scrollHeight,10)*(parseInt(c.children("li:visible").length,10)-Math.round(d.height/2))}else{g.removeClass("auto-focus");g=g.prevAll("li:visible:first");e=parseInt(g.prevAll("li:visible").length,
10);h=parseInt(g.nextAll("li:visible").length,10);if((h>Math.round(d.height/2)||e<=Math.round(d.height/2))&&typeof g.get(0)!="undefined")c.get(0).scrollTop=parseInt(g.get(0).scrollHeight,10)*(e-Math.round(d.height/2))}c.children("li").removeClass("auto-focus");g.addClass("auto-focus")}})}function O(b){if(d.newel){c.children("li[fckb=1]").remove();if(b.length!=0){var a=f(document.createElement("li"));a.attr({rel:b,fckb:"1"}).html(b);c.prepend(a);x++}}}function F(b,a){var e="";for(o=0;o<a.get(0).attributes.length;o++)if(a.get(0).attributes[o].nodeValue!=
null)e+='"_'+a.get(0).attributes[o].nodeName+'": "'+a.get(0).attributes[o].nodeValue+'",';e="{"+e+" notinuse: 0}";try{eval(b+"("+e+")")}catch(h){}}function L(){if(g==null)return false;if(g.length==0)return false;return true}function z(b){b=b.replace(/[\"\'][\s]*javascript:(.*)[\"\']/g,'""');b=b.replace(/script(.*)/g,"");b=b.replace(/eval\((.*)\)/g,"");return b=b.replace("/([\u0000-\u0008,\u000b-\u000c,\u000e-\u0019])/","")}function A(b){return d.sep_keycodes[b]===true}var q={UP:38,DOWN:40,DEL:46,
TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,FORWARD_SLASH:191},m=null,c=null,k=null,x=0,p=[],G=false,v="",g=null,y=0,r=false,s,H=false,i=f(j),w=i.attr("id");M();N();E(0);j={};for(var o=0;o<d.sep_keycodes.length;o++)j[d.sep_keycodes[o]]=true;d.sep_keycodes=j;i.bind("addItem",function(b,a,e){t(a,e)})};f.FCBKCompleter.defaults={holder_class:"holder",results_class:"facebook-auto",complete_text:"Start to type...",accept_on_blur:false,cache:true,filter_case:false,filter_hide:false,
firstselected:false,height:"10",json_url:null,maxshownitems:20,newel:false,onselect:"",onremove:"",delay:500,sep_keycodes:[13],render_cache_object:function(j){return'<li rel="'+j.value+'">'+itemIllumination(j.caption,etext)+"</li>"},cache_object:function(j){return j.caption?{caption:j.caption,value:j.value}:{caption:option.text(),value:option.val()}}}})(jQuery);
